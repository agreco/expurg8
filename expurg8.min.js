!function(t,e,n){"use strict";function i(t,e){return isNaN(t)?0/0:Math.round(parseFloat(t)*parseFloat("1e"+e))}function r(t,e){if(isNaN(t))return 0/0;var n=parseFloat(t)/parseFloat("1e"+e);return isNaN(n)||0===Math.abs(n)||0===e?n:parseFloat(n.toPrecision(e))}function a(t){return"array"==D.ntype(t)}function s(t){return"boolean"==D.ntype(t)}function o(t){return"date"==D.ntype(t)&&!isNaN(+t)}function c(t){return"function"==D.ntype(t)}function u(t){return l(t)&&Math.floor(t)===t}function l(t){return"number"==D.type(t)}function h(t){return"object"==D.ntype(t)}function p(t){return t instanceof F.Schema.Property}function f(t){return"regexp"==D.ntype(t)}function m(t){return"string"==D.ntype(t)}function d(t){return t instanceof F.Schema}function y(t){return t instanceof F.type.Object}function g(t){return"^"+e+"."+t}function v(){return!0}function b(t){return this.pattern.test(t)}function x(e,n){h(e)&&!n&&(n=e,e=n.classname,delete n.classname,!e&&n.type&&(e=n.type,delete n.type)),h(n)||(n=D.obj());var i,r;return m(e)?(e=e.toLowerCase(),e.indexOf("[]")>0&&!(e in Y.Class)&&(n.itemType=e.split("[")[0],e="collection"),i=Y.Class[e]||t.get(e)||t.get(g(e)),i&&i.prototype instanceof F.Sanitizer||(r="{0}.create: No Class found with name: {1}.")):r="{0}.create: Invalid Class name. Expected the name of an existing {0}.Sanitizer Class instead received: {1}",!r||N({classname:e,configuration:n,message:D.format(r,"{Name}",e)}),i?new i(n):null}function I(e,n){h(n)||N({descriptor:n,message:"Invalid Class definition",name:e}),n.module||(n.module=F),n.module===F&&(e=g(e));var i=n.alias;return delete n.alias,m(i)&&(i=i.split(" ")),a(i)||(i=[]),C(t.define(e,n),i)}function N(t,n){h(t)&&(n=t,t=n.type||"error",delete n.type),h(n)||(n={message:n}),m(n.message)&&(n.message=D.gsub(n.message,{Name:e})),c(n.trace)||(n.trace=N);var i=Y.Class[(t+"").toLowerCase()]||N.Error;if(n=new i(n),!(n instanceof F.error.Warning))throw n;console.warn(n)}function E(t){return t instanceof F.Sanitizer?t:Y.instance[(t+"").toLowerCase()]||null}function _(t){if(t instanceof F.Sanitizer)return t;switch(D.ntype(t)){case"string":return E(t=t.toLowerCase())||(t in Y.Class?Y.Class[t].create():x(t));case"object":return"classname"in t?x(t):null}return null}function T(t,e){return e=(e+"").toLowerCase(),!(e in Y.Class)||N({classname:t[O],message:D.format("Cannot overwrite existing alias — {0}.",e)}),Y.Class[e]=t}function w(t){if(m(t.id)){var e=t.id.toLowerCase();if(t instanceof F.Schema.Property){if(!m(Object.value(t,"schema.id")))return t;e=D.format("{0}:{1}",t.schema.id.toLowerCase(),e)}e in Y.instance||(Y.instance[e]=t)}return t}function C(t,e){return e.unshift(t[O]),e.reduce(T,t)}function j(t){if(m(t.id)){var e=t.id.toLowerCase();!(e in Y.instance)||Y.instance[e]!==t||delete Y.instance[e]}return t}function S(t,e,n){this.schema=t,this.data=e,this.value=n||(a(raw)?[]:D.obj())}var k,A,O="__classname__",M="__properties__",P="__super__",L=17,R=Math.pow(2,32)-1,D=t.util,F=D.obj(),Y={Class:D.obj(),instance:D.obj()},z=/[\r\n]+/gm;h(Object.value(n,e+".api"))?(A=n[e].api,delete n[e]):A=D.obj(),h(A.date)||(c(Date.coerce)?A.date={default_format:"c",between:function(t,e,n){return t.between(e,n)},coerce:function(t,e){return Date.coerce(t,e)},format:function(t,e){return t.format(e)}}:N("error","{Name}.api.date not detected, please supply an API for Date parsing and formatting or include the default: https://github.com/constantology/d8")),D.iter(n)||(n="commonjs"==D.ENV?module:D.global),D.iter(n[e])&&(h(Object.value(n,e+".api"))&&(A=n[e].api),l(Object.value(n,e+".DECIMAL_PRECISION"))&&(L=n[e].DECIMAL_PRECISION),l(Object.value(n,e+".MAX_ARRAY_LENGTH"))&&(R=n[e].MAX_ARRAY_LENGTH),delete n[e]),D.defs(F=D.expose(F,e,n),{DECIMAL_PRECISION:L,MAX_ARRAY_LENGTH:R,api:{value:A},lib:{value:t},create:x,define:I,error:N,get:E,lookup:_},"w",!0),D.x(Object,Array,Boolean,Function),I("Sanitizer",function(){return{constructor:function(t){this.parent(arguments).test()||N("TypeError",{configuration:t,instance:this,message:this.constructor[O]+": Invalid Configuration"}),w(this)},alias:null,id:null,coerce:function(t){return this.valid(t=this.value(t))?t:null},destroy:function(){j(this).parent(arguments)},valid:function(){return!0},test:function(){return this.valid()},value:function(t){return t}}}()),S.prototype={constructor:S,data:null,schema:null,value:null,valueOf:function(){return this.value}},I("Schema",function(){function t(t,e){switch(D.ntype(t)){case"function":if(p(t))break;if(!y(t)&&!d(t))return null;case"string":t={type:t};break;case"object":if("type"in t)break;return null}return"id"in t||(t.id=e),t}function e(e,n,i){var r=t(n,i);return null===r?N("warning",{config:n,instance:this,message:"{Name}.Schema: Invalid Property Configuration"}):e.push(r),e}function n(e,n,i){var r=t(n,i);return null===r?N("warning",{Class:this,classname:this[O],config:n,message:"{Name}.Schema: Invalid Property Configuration"}):e[r.id]=r,e}return{afterdefine:function(t){var e=t[P],i=t.prototype.properties;delete t.prototype.properties,a(i)&&(i=i.reduce(n.bind(t),D.obj())),h(i)||(i=D.obj()),D.def(t,M,{value:h(e[M])?D.update(i,e[M]):i},"r",!0)},beforeinstance:function(t,i,r){var s=h(r[0])?r[0]:r[0]={properties:D.obj()};a(s.properties)&&(s.properties=s.properties.reduce(n.bind(t),D.obj())),h(s.properties)||(s.properties=D.obj()),!h(t[M])||D.update(s.properties,t[M]),s.properties=Object.reduce(s.properties,e.bind(this),[])},alias:"schema",extend:F.Sanitizer,cast:null,properties:null,coerce:function(t){return this.properties.reduce(this.aggregate,new S(this,t,this.value(t))).value},valid:function(t){return this.properties.every(this.validProperty,t)},aggregate:function(t,e){return e.coerce(t),t},init:function(){this.properties=this.properties.map(this.initProperty,this)},initProperty:function(t){return p(t)?t:x("property",D.copy(t,{schema:this}))},test:function(){return a(this.properties)&&!!this.properties.length&&this.properties.every(p)},validProperty:function(t){return t.valid(this)},value:function(t){switch(D.ntype(this.cast)){case"function":return this.cast();case"string":switch(this.cast){case"{}":return D.obj();case"[]":return[]}}return a(t)?[]:D.obj()}}}()),I("Schema.Property",{alias:"property",extend:F.Sanitizer,mixins:{minmax:e+".validation.MinMax"},_id:null,_path:null,cite:null,type:null,coerce:function(t){t instanceof S||N("typeerror",{config:t,instance:this,message:D.format("{Name}.Schema.Property#coerce: expected instance of private Class — Accumulator — not: {0}",t)});var e=this.value(t.data);return e=this.hasMany?this.mixin("minmax",[e]):this.type.coerce(e),this.assign(t.value,e),t},valid:function(){return this.mixin("minmax",arguments)},assign:function(t,e){var n=a(this._path)?D.bless(this._path,t):t;return n[this._id]=e,t},init:function(){this.initType(this.type).initMappings(this.cite,this.id).mixin("minmax")},initMappings:function(t,e){if(m(t)||(t=e),this.cite=t,this.id=e,m(e)&&~e.indexOf(".")){var n=e.split(".");this._id=n.pop(),n.length&&(this._path=n)}else this._id=this.id},initType:function(t){var e,n=y(t)||d(t)?t:null;if(!n)switch(D.ntype(t)){case"string":n=_(t);break;case"object":"type"in t?(e=t.type,delete t.type,n=x(e,t)):n=x(t)}this.type=n},test:function(){return(y(this.type)||d(this.type))&&(m(this._id)||l(this._id))&&this.mixin("minmax")},value:function(t){return Object.value(t,this.cite)}}),I("type.Object",{alias:"{} auto mixed object",extend:F.Sanitizer,contingency:{get:function(){return c(this.fallback)?this.fallback():this.fallback},set:function(t){return N("warning",{instance:this,message:this.constructor[O]+": Over-writing `contingency` property is not allowed, please use the `fallback` property instead."}),t}},fallback:null,coerce:function(t){return this.valid(t=this.value(t))?t:this.contingency},stringify:function(t){return JSON.stringify(this.coerce(t))},valid:function(t){return this.validType(t)},test:function(){return this.valid(this.contingency)},validType:function(t){return t!==k},value:function(t){return t===k?this.contingency:t}}),I("type.Boolean",{alias:"bool boolean",extend:F.type.Object,fallback:!1,validType:s,value:Boolean.coerce}),I("type.Number",{alias:"num number",extend:F.type.Object,fallback:0,max:Number.POSITIVE_INFINITY,min:Number.NEGATIVE_INFINITY,precision:F.DECIMAL_PRECISION,coerce:function(t){return t=this.value(t),t>this.max&&(t=this.max),this.min>t&&(t=this.min),this.valid(t,!0)?r(t,this.precision):this.contingency},valid:function(t,e){if(!l(t))return!1;var n=e===!0?t:i(t,this.precision);return this.parent(arguments)&&this.max>=n&&n>=this.min&&(e===!0||r(n,this.precision)===t)},init:function(){switch(this.parent(),l(this.precision)||(this.precision=F.DECIMAL_PRECISION),this.precision=Math.abs(Math.round(this.precision)),D.ntype(this.fallback)){case"function":break;default:this.fallback=r(this.value(this.fallback),this.precision)}this.max!==Number.POSITIVE_INFINITY&&(this.max=this.value(this.max)),this.min!==Number.NEGATIVE_INFINITY&&(this.min=this.value(this.min))},test:function(){return this.valid(this.max,!0)&&this.valid(this.min,!0)&&u(this.precision)&&this.precision<=F.DECIMAL_PRECISION&&Math.abs(this.precision)===this.precision&&this.parent()},validType:l,value:function(t){return i(t,this.precision)}}),I("type.Integer",{alias:"int integer",extend:F.type.Number,precision:0,valid:function(t){return this.parent(t,!0)&&Math.floor(t)===t},init:function(){var t=this.max,e=this.min;this.precision=0,this.parent(arguments),t!==Number.POSITIVE_INFINITY&&(this.max=t),e!==Number.NEGATIVE_INFINITY&&(this.min=e)},value:function(){return Math.round(this.parent(arguments))}}),I("type.Array",{alias:"[] array",extend:F.type.Object,max:F.MAX_ARRAY_LENGTH,min:0,coerce:function(t,e){return t=this.prune(this.value(t)),e===!0||this.valid(t)?t:this.contingency},valid:function(t){return this.parent(arguments)&&t.length<=this.max&&t.length>=this.min},fallback:function(){return[]},init:function(){this.parent(),this.max=this.max>>>0,this.min=this.min>>>0},prune:function(t){if(this.validType(t)&&(t.length>this.max&&(t.length=this.max),t.length<this.min)){var e=this.contingency.slice(0,this.min-t.length);t.push.apply(t,e)}return t},test:function(){return u(this.max)&&u(this.min)&&this.max<=F.MAX_ARRAY_LENGTH&&this.min>=0&&this.max>=this.min&&this.parent()},validType:a,value:function(t){return this.validType(t)?t:Array.coerce(t)}}),I("type.Collection",{alias:"collection",extend:F.type.Array,itemType:null,coerce:function(t){t=this.parent(t,!0);for(var e=-1,n=t.length;n>++e;)t[e]=this.coerceItem(t[e]);return this.valid(t)?t:this.contingency},valid:function(t){return this.parent(arguments)&&t.every(this.validItem,this)},coerceItem:function(t){return this.itemType.coerce(t)},init:function(){this.parent();var t=this.itemType;switch(D.ntype(t)){case"string":t=_(t);break;case"object":t instanceof F.Sanitizer||(t=x(t));break;default:t=null}D.def(this,"itemType",{value:t},"e",!0)},test:function(){return this.itemType instanceof F.Sanitizer&&this.parent()},validItem:function(t){return this.itemType.valid(t)}}),I("type.String",{alias:"str string",extend:F.type.Array,fallback:"",flags:null,pattern:null,trim:!0,valid:function(t){return this.parent(arguments)&&(0===t.length&&0===this.min||this.validStr(t))},init:function(){this.parent(),m(this.pattern)&&(this.pattern=RegExp(this.pattern,m(this.flags)?this.flags:"")),f(this.pattern)?this.validStr=b:this.pattern=null},prune:function(t){return this.validType(t)&&(t.length>this.max&&(t=t.substring(0,this.max)),t.length<this.min&&(t+=this.contingency.substring(0,this.min-t.length))),t},validStr:v,validType:m,value:function(t){switch(D.ntype(t)){case"string":break;case"null":case"undefined":return this.contingency;default:if(D.tostr(t)===""+t)return this.contingency;t=""+t}return t=this.trim===!1?t:t.trim()}}),I("type.Enum",{alias:"enum",extend:F.type.Object,list:null,inverted:!1,valid:function(t){var e=!!~this.list.indexOf(t);return this.parent(arguments)&&(this.inverted===!0?!e:e)},fallback:function(){return this.list[0]},init:function(){this.parent(),m(this.list)&&(this.list=this.list.split(" "))},test:function(){return a(this.list)&&this.parent()}}),I("type.Date",{alias:"date",extend:F.type.Object,format:A.date.default_format,max:3250368e7,min:-621672192e5,coerce:function(t){return t=this.parent(arguments),+t>+this.max?new Date(+this.max):+this.min>+t?new Date(+this.min):t},stringify:function(t){return A.date.format(this.coerce(t),this.format)},valid:function(t){return this.parent(arguments)&&A.date.between(t,this.min,this.max)},fallback:function(){return new Date},init:function(){this.parent(),m(this.fallback)&&(this.fallback=this.value(this.fallback)),this.max=this.value(this.max),this.min=this.value(this.min)},test:function(){return this.valid(this.max)&&this.valid(this.min)&&this.parent()},validType:o,value:function(t){switch(D.ntype(t)){case"date":return t;case"number":return new Date(t);case"string":return A.date.coerce(t,this.format)}return this.contingency}}),I("error.Exception",{constructor:function(t){h(t)?(t.instance&&(t.classname=t.instance.constructor[O]),!c(Error.captureStackTrace)||Error.captureStackTrace(this,t.trace||this.constructor),delete t.trace,D.copy(this,t)):this.message=t+"",this.parent(this.constructor[O]+": "+this.message)},alias:"error exception",extend:Error,name:"Expurg8Exception",trace:{get:function(){return m(this.stack)?this.stack.split(z).invoke("trim"):[]}},toString:function(){return this.message}}),I("error.RangeException",{alias:"rangeerror rangeexception",extend:N.Exception,name:"Expurg8RangeException"}),I("error.TypeException",{alias:"typeerror typeexception",extend:N.Exception,name:"Expurg8TypeException"}),I("error.Warning",{alias:"warning",extend:N.Exception,name:"Expurg8Warning"})}("undefined"!=typeof id8?id8:"undefined"!=typeof require?require("id8"):null,"expurg8");